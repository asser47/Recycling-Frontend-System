<div class="rewards-page">
  <div class="rewards-container">

    <!-- Header Section -->
    <div class="page-header">
      <div class="header-content">
        <div class="title-wrapper">
          <div class="icon-badge">üéÅ</div>
          <div>
            <h1 class="page-title">{{ t('rewards') || 'Rewards Store' }}</h1>
            <p class="page-subtitle">{{ t('redeemDescription') || 'Redeem your points for amazing rewards' }}</p>
          </div>
        </div>
      </div>

      <!-- Stats & Cart Row -->
      <div class="stats-cart-row">
        <!-- Points Card -->
        <div class="stats-card">
          <app-citizen-stats-cards [stats]="stats()"></app-citizen-stats-cards>
        </div>

        <!-- Cart Button -->
        <button class="cart-button" (click)="openCart()">
          <div class="cart-button-content">
            <div class="cart-icon-wrapper">
              <span class="cart-icon">üõí</span>
              @if (cartItemCount() > 0) {
                <span class="cart-badge-count">{{ cartItemCount() }}</span>
              }
            </div>
            <div class="cart-details">
              <span class="cart-label">My Cart</span>
              <span class="cart-info">{{ cartItemCount() }} items ¬∑ {{ cartTotal() }} pts</span>
            </div>
          </div>
          <span class="cart-arrow">‚Üí</span>
        </button>
      </div>
    </div>

    <!-- Search Section -->
    <div class="search-section">
      <div class="search-wrapper">
        <div class="search-icon">üîç</div>
        <input
          class="search-input"
          placeholder="Search rewards..."
          [(ngModel)]="searchTerm"
          (keyup.enter)="search()"
          (input)="search()">
        @if (searchTerm) {
          <button class="clear-search-btn" (click)="resetSearch()">‚úï</button>
        }
      </div>
    </div>

    <!-- Toast Notification -->
    @if (showToast) {
      <div class="toast" [class.toast-success]="toastType === 'success'" [class.toast-error]="toastType === 'error'">
        <div class="toast-icon">
          @if (toastType === 'success') {
            <span>‚úì</span>
          } @else {
            <span>‚úï</span>
          }
        </div>
        <div class="toast-body">
          <p class="toast-title">{{ toastType === 'success' ? 'Success' : 'Error' }}</p>
          <p class="toast-message">{{ toastMessage }}</p>
        </div>
        <button class="toast-close" (click)="closeToast()">‚úï</button>
      </div>
    }

    <!-- Loading State -->
    @if (isLoading) {
      <div class="loading-state">
        <div class="spinner"></div>
        <p>Loading rewards...</p>
      </div>
    }

    <!-- Empty State -->
    @if (!isLoading && rewards.length === 0) {
      <div class="empty-state">
        <div class="empty-icon">üéÅ</div>
        <h2 class="empty-title">No Rewards Found</h2>
        <p class="empty-description">
          @if (searchTerm) {
            No rewards match your search. Try different keywords.
          } @else {
            Check back later for amazing rewards you can redeem with your points!
          }
        </p>
        @if (searchTerm) {
          <button class="btn-primary" (click)="resetSearch()">Clear Search</button>
        }
      </div>
    }

    <!-- Rewards Grid -->
    @if (!isLoading && rewards.length > 0) {
      <div class="rewards-grid">
        @for (r of rewards; track r.id) {
          <div class="reward-card" 
               [class.reward-card-available]="canRedeem(r)"
               [class.reward-card-disabled]="!canRedeem(r) || r.stockQuantity === 0">
            
            <!-- Stock Badge -->
            @if (r.stockQuantity === 0) {
              <div class="badge badge-danger">Out of Stock</div>
            } @else if (r.stockQuantity <= 5) {
              <div class="badge badge-warning">{{ r.stockQuantity }} left!</div>
            }

            <!-- Reward Image -->
            <div class="reward-image">
              <img [src]="r.imageUrl" [alt]="r.name">
            </div>

            <!-- Reward Content -->
            <div class="reward-content">
              <h3 class="reward-name">{{ r.name }}</h3>
              <p class="reward-description">{{ r.description }}</p>

              <!-- Points Badge -->
              <div class="reward-points-badge">
                <span class="points-icon">‚≠ê</span>
                <span class="points-amount">{{ r.requiredPoints }}</span>
                <span class="points-label">points</span>
              </div>

              <!-- Stock Info -->
              <div class="stock-info">
                <span class="stock-icon">üì¶</span>
                <span class="stock-text" 
                      [class.text-danger]="r.stockQuantity === 0"
                      [class.text-warning]="r.stockQuantity > 0 && r.stockQuantity <= 5"
                      [class.text-success]="r.stockQuantity > 5">
                  {{ r.stockQuantity }} in stock
                </span>
              </div>

              <!-- Cart Button -->
              <button class="cart-action-btn"
                      [class.cart-action-btn-added]="isInCart(r)"
                      [class.cart-action-btn-disabled]="!canRedeem(r) && !isInCart(r)"
                      [disabled]="!canRedeem(r) && !isInCart(r)"
                      (click)="isInCart(r) ? removeFromCart(r) : addToCart(r)">
                @if (isInCart(r)) {
                  <span class="btn-icon">‚úì</span>
                  <span>Remove from Cart</span>
                } @else if (r.stockQuantity === 0) {
                  <span class="btn-icon">‚úï</span>
                  <span>Out of Stock</span>
                } @else if (userPoints() < r.requiredPoints) {
                  <span class="btn-icon">üîí</span>
                  <span>Need {{ r.requiredPoints - userPoints() }} pts</span>
                } @else {
                  <span class="btn-icon">+</span>
                  <span>Add to Cart</span>
                }
              </button>
            </div>
          </div>
        }
      </div>
    }
  </div>
</div>

<!-- Cart Modal -->
@if (showCartModal()) {
  <div class="modal-overlay" (click)="closeCart()"></div>
  <div class="cart-modal">
    <!-- Modal Header -->
    <div class="modal-header">
      <div class="modal-title">
        <span class="modal-icon">üõí</span>
        <h2>My Cart</h2>
      </div>
      <button class="modal-close-btn" (click)="closeCart()">‚úï</button>
    </div>

    <!-- Modal Body -->
    <div class="modal-body">
      @if (cart().length === 0) {
        <div class="cart-empty">
          <div class="cart-empty-icon">üõí</div>
          <h3>Your cart is empty</h3>
          <p>Add some rewards to get started!</p>
        </div>
      } @else {
        <div class="cart-items">
          @for (item of cart(); track item.id) {
            <div class="cart-item">
              <div class="cart-item-img">
                <img [src]="item.imageUrl" [alt]="item.name">
              </div>
              <div class="cart-item-details">
                <h4>{{ item.name }}</h4>
                <p class="cart-item-points">‚≠ê {{ item.requiredPoints }} points</p>
              </div>
              <button class="cart-item-remove" (click)="removeFromCart(item)" title="Remove">
                üóëÔ∏è
              </button>
            </div>
          }
        </div>
      }
    </div>

    <!-- Modal Footer -->
    @if (cart().length > 0) {
      <div class="modal-footer">
        <div class="cart-summary">
          <div class="summary-row">
            <span>Items:</span>
            <strong>{{ cartItemCount() }}</strong>
          </div>
          <div class="summary-row summary-total">
            <span>Total Points:</span>
            <strong class="text-primary">{{ cartTotal() }}</strong>
          </div>
          <div class="summary-row">
            <span>Your Balance:</span>
            <strong [class.text-success]="cartTotal() <= userPoints()" 
                    [class.text-danger]="cartTotal() > userPoints()">
              {{ userPoints() }}
            </strong>
          </div>
          @if (cartTotal() > userPoints()) {
            <div class="insufficient-points">
              ‚ö†Ô∏è Need {{ cartTotal() - userPoints() }} more points!
            </div>
          }
        </div>

        <div class="cart-actions">
          <button class="btn-secondary" (click)="clearCart()" [disabled]="cart().length === 0">
            Clear Cart
          </button>
          <button class="btn-primary" 
                  (click)="redeemCart()"
                  [disabled]="cart().length === 0 || cartTotal() > userPoints() || isCheckingOut()">
            @if (isCheckingOut()) {
              <span class="btn-spinner"></span>
              <span>Processing...</span>
            } @else {
              <span>Redeem All</span>
            }
          </button>
        </div>
      </div>
    }
  </div>
}
